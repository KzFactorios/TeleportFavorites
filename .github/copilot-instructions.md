# IMPORTANT: All code, API usage, and modding guidance in this project MUST target Factorio v2.0+ and above. Do not use deprecated or legacy patterns from earlier versions. Always verify compatibility and reference the v2.0+ documentation for all features, prototypes, and runtime logic.
# TeleportFavorites Factorio Mod â€” AI Agent Instructions

## ðŸŽ¯ PROJECT OVERVIEW

TeleportFavorites is a **multiplayer-safe Factorio mod** that enables instant teleportation to favorite locations via map tags. Key features:

## ðŸ—ï¸ ARCHITECTURE QUICK START

### Module Structure
```
core/
â”œâ”€â”€ cache/           # Data persistence (storage.players, storage.surfaces)
â”œâ”€â”€ control/         # GUI controllers & lifecycle management  
â”œâ”€â”€ events/          # Event handlers & dispatcher patterns
â”œâ”€â”€ favorite/        # Favorite object logic & player favorite management
â”œâ”€â”€ tag/             # Map tag objects & synchronization
â”œâ”€â”€ teleport/        # Teleportation logic & history
â””â”€â”€ utils/           # Helper modules (GPS, validation, GUI builders)

gui/
â”œâ”€â”€ favorites_bar/   # Top-screen favorites bar interface
â””â”€â”€ tag_editor/      # Right-click map tag creation/editing

prototypes/          # Factorio data-stage definitions
tests/              # Custom test framework with smoke testing
```

### Data Flow Pattern
**User Input** â†’ **Event Handler** â†’ **Storage Update** â†’ **GUI Refresh**
- All persistent data flows through `core/cache/cache.lua`
- Surface-aware data management for multiplayer compatibility


### 1. Require Statement Policy
```lua
-- âœ… ALWAYS at file top
## ðŸ›¡ï¸ CODING STANDARDS & BEST PRACTICES (STRICT)

### EmmyLua Annotation Requirements
- All classes, fields, and methods must be annotated for strictness and IDE support. Use `---@class`, `---@field`, `---@param`, and `---@return` for documentation and static analysis. See `core/types/factorio.emmy.lua` for Factorio runtime types and type aliases.

### Helper/Module Structure & Circular Dependency Policy
- All require statements must be at the very top of each file, ordered alphabetically, before any logic or function definitions. Never place require statements inside functions, event handlers, or at the end of files.
- If a circular dependency is detected, refactor shared logic into minimal, dependency-free helper modules (see `core/utils/basic_helpers.lua`). Never use require-at-end or require-in-function patterns.
- Helper modules must not depend on higher-level modules. If a helper is needed in multiple places, move it to a lower-level, dependency-free module.

### GUI Element Naming Convention
- All interactive and structural GUI element names (buttons, labels, textfields, frames, flows, etc.) must be prefixed with their GUI/module context, using the format `{gui_context}_{purpose}_{type}`. Example: `tag_editor_move_button`, `fave_bar_slot_button_1`.
- Update all event handler checks and variable references to use the new names when refactoring or adding new elements.

### No Leading Underscores for Private Fields
- For private or internal fields in classes, do not use a leading underscore (e.g., use `chart_tag` instead of `_chart_tag`).

### Error-Free Code Policy
- All code contributions, including those generated by automated agents, must be error-free to the best of the contributor's ability. No syntax errors, runtime errors, or Factorio data stage errors should be present in any committed or proposed code. All Lua code must be valid and loadable by Factorio without warnings or errors.
- Automated agents (such as Copilot) must validate and ensure their code is error-free before submitting or applying changes. If an error is detected after submission, it must be fixed immediately.

### Paradigms and Patterns
 - **Class-based OOP:** Use idiomatic Lua class patterns with strict EmmyLua annotations.
 - **Design Patterns:** Adapter, Facade, Proxy, Singleton, Observer, Builder, Command, Strategy, Composite. Pattern base classes are in `core/pattern/` or `core/patterns/` and documented in `.project/pattern_class_notes.md`.
 - **Surface Awareness:** All helpers and accessors must be surface-aware and multiplayer-safe.
 - **Event-driven Architecture:** Use Factorio's event system for initialization, surface management, and runtime cache handling. Register event handlers in `control.lua`.
 - **Persistent vs. Runtime Data:** Persistent data must be managed via the `core/cache` module and stored in `storage`. Runtime-only (non-persistent) data must use the runtime cache (`core/cache/lookups.lua`).
 - **Shared Tag Mutation Helper:** Always use `Tag.update_gps_and_surface_mapping(old_gps, new_gps, chart_tag, player)` for chart tag position changes. This centralizes tag data movement, tag object updates, and runtime cache synchronization for multiplayer and surface consistency.

### Vanilla Factorio Utility Sprite Usage
- Only use the following vanilla utility sprites for GUIs:
  - utility/list_view, utility/close, utility/refresh, utility/arrow-up, utility/arrow-down, utility/arrow-left, utility/arrow-right
- Do NOT use: utility/minus, utility/plus, utility/remove, utility/add, utility/tab_icon, utility/up_arrow, utility/down_arrow. These do NOT exist in vanilla Factorio and will cause exceptions.
- For more icons, check the [Factorio Wiki: Prototype/Sprite](https://wiki.factorio.com/Prototype/Sprite#Sprites) or inspect the game's utility-sprites.png for available names.

### Commit & Review Process
- Lint before commit
- Run tests before submitting
- Document all changes

### Shell Command Formatting
- Use PowerShell syntax: This project is developed on Windows using PowerShell.
- Use semicolons (`;`) instead of `&&` for command chaining.
- Use PowerShell path conventions: Use backslashes (`\`) or forward slashes (`/`) consistently.
- Format multi-line commands properly: Use backticks for line continuation in PowerShell.

---
local Cache = require("core.cache.cache")
local PlayerHelpers = require("core.utils.player_helpers")

-- âŒ NEVER inside functions, conditionals, or at file end
function some_function()
  local Module = require("some.module")  -- FORBIDDEN!
end
```

### 2. Storage as Source of Truth
```lua
-- âŒ NEVER read from GUI
local text = text_element.text

-- âœ… ALWAYS read from storage
local tag_data = Cache.get_tag_editor_data(player)
local text = tag_data.text
```

### 3. Function Structure
- All functions must be **top-level** (never nested inside other functions)
- Match every `function` with corresponding `end` at same indentation
- Use proper Factorio API syntax: `:` for methods, `.` for properties

## ðŸ”§ DEVELOPMENT WORKFLOW

### Testing Commands (Universal - Work from Any Directory)
```powershell
# Run full test suite
.\.test.ps1        # PowerShell (recommended)
.test.bat         # Batch file  
lua .test.lua     # Direct Lua

# Check code line count (target: under 10,000 lines production code)
python .scripts\analyze_lua_lines.py
```

### PowerShell Environment Notes
**This project is developed on Windows with PowerShell as the default shell.** When generating terminal commands:
- Use PowerShell syntax: `Get-ChildItem`, `Select-Object`, `Where-Object` 
- NOT Unix commands: `ls`, `head`, `tail`, `grep`
- Use `Select-String` instead of `grep`
- Use `-First N` instead of `head -N`
- Use proper PowerShell pipe syntax and object handling

## âš ï¸ COST EFFICIENCY AND COMMAND ACCURACY

**CRITICAL**: Misconfigured or erroneous commands cost money per request. The agent must stay vigilant and maintain accurate PowerShell command patterns. **If an antipattern is discovered that has not been documented, it MUST be documented in these instructions before using a corrected command.**

### PowerShell Anti-Patterns to Avoid

**âŒ COMMON COMMAND FAILURES:**
```powershell
# BROKEN: Select-String with -A parameter (After context)
.\.test.ps1 | Select-String -Pattern "Total tests.*:" -A 2
# ERROR: "The input object cannot be bound to any parameters"

# BROKEN: Select-String with -A parameter on script output (After context lines)
.\.test.ps1 | Select-String -Pattern "Failed|Failures" -A 10
# ERROR: "The input object cannot be bound to any parameters for the command"

# BROKEN: Complex regex patterns in Select-String with pipeline from scripts
.\.test.ps1 | Select-String -Pattern "Failed|Total tests passed|Total tests failed" -Context 1
# ERROR: Parameter binding exceptions when script output contains objects

# BROKEN: Using Unix-style commands
ls -la | grep pattern
head -10 file.txt
tail -f log.txt

# BROKEN: Using Unix && operator for command chaining
.\.test.ps1 > test_output.txt 2>&1 && Get-Content test_output.txt
# ERROR: "The token '&&' is not a valid statement separator"

# BROKEN: Complex pipeline combinations with script output
.\.test.ps1 | Out-String | Select-String "Overall Test Summary" -A 10
# ERROR: Parameter binding exceptions due to object/string conversion issues

# BROKEN: Trying to pipe script objects directly to Select-String with context
(.\.test.ps1) | Select-String "Total tests" | Select-Object -Last 3
# ERROR: PowerShell treats script output as objects, not strings, causing binding failures

# BROKEN: Using lua -c for syntax checking (incorrect parameter)
lua -c tests\specs\drag_drop_utils_spec.lua
# ERROR: "-c" is not a valid parameter for lua.exe - shows usage help instead

# BROKEN: Mixing Unix dir command with PowerShell in complex pipelines  
Set-Location tests; dir /b "specs\*_spec.lua" | Select-String "drag_drop"
# ERROR: "dir /b" is cmd syntax, creates path confusion and pipeline errors in PowerShell
```

### File Organization Rules

**âŒ NEVER place test-related files in root directory:**
- test_output.txt, test_output_latest.txt, debug_test_runner.lua, debug_vehicle_test.lua
- All test files belong in tests/ directory or subdirectories
- Root directory should only contain production mod files and essential config files

**âœ… CORRECT file placement:**
- Production code: core/, gui/, prototypes/, graphics/
- Test files: tests/specs/, tests/output/, tests/mocks/
- Config files: .vscode/, .github/, .project/

**âœ… CORRECT POWERSHELL PATTERNS:**
```powershell
# Use parentheses to force string output before piping
(.\.test.ps1) | Select-String -Pattern "pattern"

# Use Out-String to convert objects to strings
.\.test.ps1 | Out-String | Select-String -Pattern "Failed"

# Use PowerShell native cmdlets
Get-ChildItem -Recurse | Where-Object { $_.Name -match "pattern" }
Get-Content file.txt | Select-Object -First 10
Get-Content file.txt -Wait -Tail 10

# Use proper PowerShell operators for text replacement
(Get-Content "file.lua") -replace "old_pattern", "new_pattern" | Set-Content "file.lua"

# Use semicolon for command chaining (not &&)
.\.test.ps1 > test_output.txt 2>&1; Get-Content test_output.txt

# For test output, run tests separately then check results
.\.test.ps1
# Then check specific output files or use simpler commands
```

**âŒ NEWLY DISCOVERED ANTIPATTERN:**
```powershell
# BROKEN: Incorrect path navigation in Get-ChildItem
Get-ChildItem "tests\specs\*_spec.lua"  # When already in tests directory
# ERROR: Looks for tests\tests\specs instead of specs

# BROKEN: PowerShell path confusion with relative directories
cd tests; Get-ChildItem "tests\specs\*_spec.lua" 
# ERROR: Double-nests the path when already in subdirectory

# BROKEN: Select-String with -A parameter on any script output (CONFIRMED ANTIPATTERN)
(.\.test.ps1) | Select-String "Overall Test Summary" -A 5
# ERROR: "The input object cannot be bound to any parameters for the command either because the command does not take pipeline input or the input and its properties do not match any of the parameters that take pipeline input"
# This fails because PowerShell script output creates objects, not strings, and Select-String -A parameter cannot bind to these objects

# BROKEN: Any Select-String with context parameters (-A, -B, -C) on script output
.\.test.ps1 | Select-String -Pattern "Total tests.*:" -A 2
.\.test.ps1 | Select-String -Pattern "Failed|Failures" -A 10  
.\.test.ps1 | Select-String -Pattern "Failed|Total tests passed|Total tests failed" -Context 1
# ERROR: "The input object cannot be bound to any parameters for the command either because the command does not take pipeline input or the input and its properties do not match any of the parameters that take pipeline input"
# All of these fail because PowerShell script output produces objects, not strings, causing parameter binding failures
```

**âœ… CORRECT POWERSHELL PATTERNS:**
```powershell
# Use proper relative paths based on current directory
Get-ChildItem "specs\*_spec.lua"  # When in tests directory  
Set-Location ..; Get-ChildItem "tests\specs\*_spec.lua"  # From subdirectory to root
Get-ChildItem -Path ".\specs\*_spec.lua"  # Explicit current directory

# Check for empty files correctly
Get-ChildItem "specs\*_spec.lua" | Where-Object { (Get-Content $_.FullName -Raw -ErrorAction SilentlyContinue).Trim() -eq "" }

# CORRECT: Avoid Select-String -A entirely with script output - use direct execution instead
.\.test.ps1                                    # Run script directly and read full output
.\.test.ps1 > output.txt; Get-Content output.txt -Tail 10  # Save output then read specific lines
.\.test.ps1 2>&1 | Tee-Object -FilePath "test_results.txt"  # Capture output to file while displaying

# CORRECT: For test result analysis, run tests then check specific files
.\.test.ps1; Get-Content "tests\test_output.txt" | Select-String "Overall Test Summary" 
.\.test.ps1; Get-Content "tests\results.txt" | Where-Object { $_ -match "Failed|Total tests" }

# CORRECT: Use Out-String to convert objects to strings before Select-String (but avoid -A)
.\.test.ps1 | Out-String | Select-String -Pattern "Failed"  # Without context parameters

# For Lua syntax checking, use proper lua execution
lua -e "loadfile('tests\\specs\\drag_drop_utils_spec.lua')"  # Load and check syntax without execution
lua tests\specs\drag_drop_utils_spec.lua                     # Execute the file directly (if it's standalone)
Get-Content tests\specs\drag_drop_utils_spec.lua | lua       # Pipe file content to lua interpreter

# For file searches, use PowerShell native commands
Get-ChildItem "specs\*_spec.lua" | Where-Object { $_.Name -match "pattern" }
Get-ChildItem -Path ".\specs\*_spec.lua" -Filter "*drag_drop*"
```

### Key File Patterns
- **Entry Points**: `control.lua` (runtime), `data.lua` (data stage), `settings.lua` (mod settings)
- **Constants**: `constants.lua` - Central configuration values and limits
- **Cache Access**: Always use `Cache.get_*()` / `Cache.set_*()` - never access `storage` directly
- **Player Safety**: Use `PlayerHelpers.safe_player_print()` instead of `player.print()`
- **Validation**: Use `SafeHelpers.is_valid_player()` / `SafeHelpers.is_valid_element()`

### GUI Development
- Use `GuiElementBuilders` for consistent element creation
- Follow **storage-first** pattern: save immediately on input, read from storage for logic
- Tag editor state stored in `cache.players[index].tag_editor_data`
- Favorites bar state in `cache.players[index].surfaces[surface].favorites`

### Drag-Drop Algorithm (`DragDropUtils.reorder_slots`)
The favorites bar uses a custom **blank-seeking cascade algorithm** with these behaviors:

**Special Cases (Simple Operations):**
- **Move to blank**: Direct swap with no cascade
- **Adjacent slots**: Simple swap operation  
- **Locked slots**: Cannot be source, destination, or cascade targets

**Cascade Algorithm (Non-Adjacent, Non-Blank):**
1. **Source evacuation**: Source slot becomes blank immediately
2. **Blank detection**: Search between source and destination for existing blank slots
3. **Cascade direction**: Items shift toward the newly-created blank at source position
4. **Destination placement**: Source item gets placed at destination, displacing what was there
5. **Natural compaction**: Displaced items flow into available blanks, creating intuitive reordering

**Example**: Drag slot 10 â†’ slot 8
- Slot 10 content â†’ slot 8 (destination)
- Slot 8 content â†’ slot 9 (cascades toward blank at slot 10)
- Slot 9 content â†’ slot 10 (fills the blank)
- Result: Natural rightward shift of affected items

**Implementation Notes:**
- Returns `(modified_slots, success, error_message)` tuple
- Creates deep copy to avoid mutating input data
- Respects locked slot boundaries throughout cascade
- Provides detailed error messages for validation failures

## ðŸŽ® FACTORIO-SPECIFIC PATTERNS

### Chart Tag Ownership System
```lua
-- Only tag owner OR admin can edit
local can_edit = AdminUtils.can_edit_chart_tag(player, chart_tag)
-- Ownership tracked via chart_tag.last_user (player name string)
```

### GPS & Position Handling
```lua
-- GPS format: "x.y.surface_index" (e.g., "100.200.1")
local position = GPSUtils.map_position_from_gps(gps_string)
local gps = GPSUtils.gps_from_map_position(position, surface)
```

### Surface-Aware Data Management
All player data is organized by surface to handle multiple worlds:
```lua
storage.players[player_index].surfaces[surface_index].favorites
storage.surfaces[surface_index].tags[gps_string]
```

## ðŸ§ª TESTING PHILOSOPHY

**Simplified Smoke Testing**: Focus on execution validation over deep behavior testing.

### Test Pattern (Standard)
```lua
require("test_bootstrap")
require("mocks.factorio_test_env")

describe("ModuleName", function()
    it("should load module without errors", function()
        local success, err = pcall(function()
            local Module = require("path.to.module")
            assert(Module ~= nil, "Module should load")
        end)
        assert(success, "Module should load without errors: " .. tostring(err))
    end)
    
    it("should expose expected API methods", function()
        local Module = require("path.to.module")
        assert(type(Module.method_name) == "function", "method should exist")
    end)
end)
```

### Mock Strategy
- Mock dependencies via `package.loaded["module.path"] = mock_table`
- Use `PlayerFavoritesMocks.mock_player(1, "TestPlayer", 1)` for player objects
- Focus on smoke testing: execution validation over behavior verification
- All tests in `tests/specs/*_spec.lua` with describe/it structure

## ðŸ“š KEY DOCUMENTATION REFERENCES

**ALWAYS check these before making changes:**
- `.project/architecture.md` - Overall system design & patterns
- `.project/data_schema.md` - Storage structure & data relationships  
- `.project/coding_standards.md` - Critical rules & "storage as source of truth"
- `.project/game_rules.md` - Multiplayer permissions & tag ownership
- `tests/docs/README.md` - Test execution & framework usage


## ðŸš¨ FACTORIO API ESSENTIALS (v2.0+)

### Syntax Rules (v2.0+)
```lua
surface:get_tile(position)      # Method calls with ':'
chart_tag.position             # Property access with '.'
player.force:add_chart_tag()   # Chain method calls properly
```

### Common Validations (v2.0+)
```lua
if not player or not player.valid then return end
if not chart_tag or not chart_tag.valid then return end  
if not surface or not surface.valid then return end
```

### Event Registration Pattern
```lua
-- Via event_registration_dispatcher.lua
script.on_event(defines.events.on_gui_click, handlers.on_gui_click)
script.on_event(defines.events.on_chart_tag_added, handlers.on_chart_tag_added)
```

---

*This is a multiplayer-safe Factorio mod with complex GUI interactions. When in doubt, prioritize data consistency and player safety over convenience features.*
## ðŸ’¡ DEVELOPMENT TIPS

### Quick Problem Solving
- **Read the error**: Factorio provides detailed error messages with stack traces
- **Check storage first**: Most issues stem from incorrect data access patterns
- **Validate inputs**: Always check player/element validity before operations
- **Use the cache**: Never access `storage` directly - use `Cache.*` methods

### Common Patterns
```lua
-- Safe player operations
local function safe_operation(player)
  if not player or not player.valid then return end
  -- ... your code here
end

-- Error handling pattern
local function handle_input(input)
  if not input then return end  -- Graceful nil handling
  -- ... process input
end

-- Event handler template  
local function on_some_event(event)
  local player = game.players[event.player_index]
  if not player or not player.valid then return end
  
  -- Read from storage
  local data = Cache.get_some_data(player)
  
  -- Update storage
  data.field = new_value
  Cache.set_some_data(player, data)
  
  -- Optional: refresh UI
  refresh_ui_if_needed(player)
end
```

### Best Practices
- **Start simple**: Get basic functionality working before adding complexity
- **Test incrementally**: Use the test suite to catch regressions early
- **Document decisions**: Update `.project/` docs for significant changes
- **Follow the patterns**: Consistency is key to maintainability

---

*Remember: This mod prioritizes multiplayer safety and data consistency. When in doubt, choose the more conservative approach that preserves data integrity.*
